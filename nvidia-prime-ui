#! /bin/bash

# License:
#   This program is free software; you can redistribute it and/or
#   modify it under the terms of the GNU Lesser General Public
#   License as published by the Free Software Foundation; either
#   version 2.1 of the License, or (at your option) any later
#   version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU Lesser General Public License for more details.
#
#   You should have received a copy of the GNU Lesser General Public
#   License along with this program.  If not, see
#   <https://www.gnu.org/licenses/>.
#
## You can redistribute it as you wish : GPL v3
## author : wildtruc@noneltd.net

# color setup TODO < color.conf
end='</span>'
vB='<span color=\"#005400\" weight=\"bold\">'
j='<span color=\"#FF6800\">'
rBB='<span color=\"#FF3300\" font=\"20\">'
# prime_setup
prime_msg_01="Select the Prime setup you would like to use:"
prime_msg_02="Default is currently set to $j%s$end."
prime_msg_03=""
menu_prime_01="Set Prime to Intel device"
menu_prime_02="Set Prime to Nvidia device"
menu_prime_03="Set permanently Prime to Nvidia device"
menu_prime_04="Edit Librairies config file"
m_prime_01="intel"
m_prime_02="nvidia"
m_prime_03="permanent nvidia"
wrn_prime_01="Prime will be set to $j%s$end."
wrn_prime_02="\nYou may now restart the user session to take effect."
lib_conf=/etc/nvidia-prime/library.conf
## su cmd is manages by polkit
edit_conf(){
	edit_lib_conf=$(zenity --width=500 --height=400 --title="Libraries conf editor" --text-info \
	--editable --text="$vB\\Edit libraries and rc.d path to fit your system install.$end" \
	--filename="$lib_conf" --checkbox="Confirm to overwrite")
	if [ $(printf "$edit_lib_conf"| sed -En "s/^(.*)='(.*)'$/\2/g;p"| grep -c .) -gt 0 ]; then
		pkexec sh -c "echo -e \"$edit_lib_conf\" > $lib_conf"
#		zenity --height=100 --title="Libraries conf editor" --info --no-wrap \
#		--icon-name=nvidia-prime --timeout=5 --text="$vB\\Librairies data saved.$end"
		notify-send -t 5000 -u low  "Librairies data saved."
	fi
	bash -c nvidia-prime-ui
	exit 0
}
setup_prime(){
	zenity --height=100 --title="Zenvidia prime setup" --question --no-wrap \
	--icon-name=nvidia-prime --text="$vB$(printf "$wrn_prime_01$wrn_prime_02" "$_prime")$end" \
	--cancel-label='Cancel' --ok-label='Setup'
	if [ $? = 1 ]; then $0; fi
	for pset in "${_pset[@]}"; do
		pkexec /usr/sbin/nvidia-prime-select $pset
	done
}
#root_id
unset setup_list setup_option _pset
setup_option=(
"$menu_prime_01;$m_prime_01;intel;/etc/X11/xinit/xinitrc.d/intel"
"$menu_prime_02;$m_prime_02;nvidia;/etc/X11/xinit/xinitrc.d/nvidia"
"$menu_prime_03;$m_prime_03;nvidia;/etc/rc.d/rc.nvidia"
"$menu_prime_04;;"
)
n=1
for p_set in "${setup_option[@]}"; do
	pp_set=$(printf "$p_set"|cut -d';' -f1)
	pc_set=$(printf "$p_set"|cut -d';' -f3)
	pc_msg=$(printf "$p_set"|cut -d';' -f2)
	pc_file=$(printf "$p_set"|cut -d';' -f4)
	setup_list+=("false")
	setup_list+=("$n")
	setup_list+=("$pp_set")
	if [ $(ls -1 $pc_file| grep -c "$pc_set" ) -eq 1 ]; then
		current_set=$pc_msg
	fi
	n=$[ $n+1 ]
done

if [[ "$current_set" ]]; then
	prime_msg="$prime_msg_01\n$(printf "$prime_msg_02" "$current_set")"
else
	prime_msg="$prime_msg_01\nNo device is currently set."
fi

menu_prime=$(zenity --width=340  --list --radiolist --hide-header \
--title="Zenvidia prime setup" --text "$vB$prime_msg$end" \
--column "1" --column "2" --column "3" --separator=";" --hide-column=2 \
"${setup_list[@]}" --ok-label='Select' --cancel-label='Exit')
if [ $? = 1 ]; then exit 0; fi
case $menu_prime in
	"1") _pset=( "intel"); _prime="$m_prime_01" ;;
	"2") _pset=( "nvidia" ); _prime="$m_prime_02" ;;
	"3") _pset=( "nvidiaonly" ); _prime="$m_prime_03" ;;
	"4") edit_conf ;;
esac
setup_prime
notify-send -t 5000 -u low  "Nvidia-prime" "$_prime setup applied."
exit 0
